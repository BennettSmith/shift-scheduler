name: Generate Coverage Report

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday at midnight UTC
  push:
    branches: [ main ]
    paths:
      - 'ios/Packages/**/*.swift'

jobs:
  full-coverage-report:
    name: Full Coverage Analysis
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Test All Packages with Coverage
        run: |
          # Array of packages to test
          PACKAGES=(
            "Troop900Application"
            "Troop900Domain"
            "Troop900Data"
            "Troop900Presentation"
            "Troop900DesignSystem"
            "Troop900Bootstrap"
          )
          
          echo "# ðŸ“Š Running Tests with Coverage for All Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for package in "${PACKAGES[@]}"; do
            echo "## Testing $package..." >> $GITHUB_STEP_SUMMARY
            cd ios/Packages/$package
            
            if swift test --enable-code-coverage; then
              echo "âœ… $package - Tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ $package - Tests failed or not available" >> $GITHUB_STEP_SUMMARY
            fi
            
            cd -
          done
      
      - name: Generate Coverage Reports
        run: |
          PACKAGES=(
            "Troop900Application"
            "Troop900Domain"
            "Troop900Data"
            "Troop900Presentation"
            "Troop900DesignSystem"
            "Troop900Bootstrap"
          )
          
          mkdir -p coverage-reports
          
          for package in "${PACKAGES[@]}"; do
            echo "Generating reports for $package..."
            
            # Generate text report
            if python3 scripts/analyze_swift_coverage.py "ios/Packages/$package" 2>/dev/null; then
              cp "ios/Packages/$package/COVERAGE_REPORT.md" "coverage-reports/${package}_COVERAGE.md" || true
            fi
            
            # Generate HTML report
            if python3 scripts/generate_html_coverage.py "ios/Packages/$package" 2>/dev/null; then
              cp "ios/Packages/$package/coverage_report.html" "coverage-reports/${package}_coverage.html" || true
            fi
          done
      
      - name: Create Combined Summary
        run: |
          SUMMARY_FILE="coverage-reports/COMBINED_COVERAGE_SUMMARY.md"
          
          echo "# ðŸ“Š Combined Coverage Report - All Swift Packages" > $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "**Generated:** $(date)" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "---" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          
          PACKAGES=(
            "Troop900Application"
            "Troop900Domain"
            "Troop900Data"
            "Troop900Presentation"
            "Troop900DesignSystem"
            "Troop900Bootstrap"
          )
          
          echo "## Coverage by Package" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "| Package | Overall | Line | Branch | Status |" >> $SUMMARY_FILE
          echo "|---------|---------|------|--------|--------|" >> $SUMMARY_FILE
          
          for package in "${PACKAGES[@]}"; do
            REPORT="ios/Packages/$package/COVERAGE_REPORT.md"
            
            if [ -f "$REPORT" ]; then
              OVERALL=$(grep "Combined Coverage Score:" "$REPORT" | head -1 | grep -oE '[0-9]+\.[0-9]+%' | head -1 || echo "N/A")
              LINE=$(grep "Overall Line Coverage:" "$REPORT" | head -1 | grep -oE '[0-9]+\.[0-9]+%' | head -1 || echo "N/A")
              BRANCH=$(grep "Overall Branch Coverage:" "$REPORT" | head -1 | grep -oE '[0-9]+\.[0-9]+%' | head -1 || echo "N/A")
              
              # Determine status based on overall coverage
              OVERALL_NUM=$(echo $OVERALL | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "0")
              if [ ! -z "$OVERALL_NUM" ]; then
                if (( $(echo "$OVERALL_NUM >= 95" | bc -l) )); then
                  STATUS="ðŸŽ¯ Excellent"
                elif (( $(echo "$OVERALL_NUM >= 85" | bc -l) )); then
                  STATUS="âœ… Good"
                elif (( $(echo "$OVERALL_NUM >= 70" | bc -l) )); then
                  STATUS="âš ï¸ Fair"
                else
                  STATUS="ðŸ”´ Needs Work"
                fi
              else
                STATUS="â“ Unknown"
              fi
              
              echo "| $package | $OVERALL | $LINE | $BRANCH | $STATUS |" >> $SUMMARY_FILE
            else
              echo "| $package | N/A | N/A | N/A | âš ï¸ No data |" >> $SUMMARY_FILE
            fi
          done
          
          echo "" >> $SUMMARY_FILE
          echo "---" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "## Coverage Levels" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "- ðŸŽ¯ **Excellent (95%+)** - Production ready" >> $SUMMARY_FILE
          echo "- âœ… **Good (85-95%)** - Solid coverage" >> $SUMMARY_FILE
          echo "- âš ï¸ **Fair (70-85%)** - Needs improvement" >> $SUMMARY_FILE
          echo "- ðŸ”´ **Needs Work (<70%)** - Significant gaps" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "---" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "## How to View Reports" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "1. Download the workflow artifacts" >> $SUMMARY_FILE
          echo "2. Open the HTML files in your browser for interactive reports" >> $SUMMARY_FILE
          echo "3. Review the markdown files for detailed statistics" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "## Running Locally" >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo '```bash' >> $SUMMARY_FILE
          echo "# Test a specific package" >> $SUMMARY_FILE
          echo "cd ios/Packages/Troop900Application" >> $SUMMARY_FILE
          echo "swift test --enable-code-coverage" >> $SUMMARY_FILE
          echo "cd ../../.." >> $SUMMARY_FILE
          echo "" >> $SUMMARY_FILE
          echo "# Generate reports" >> $SUMMARY_FILE
          echo "python3 scripts/analyze_swift_coverage.py ios/Packages/Troop900Application" >> $SUMMARY_FILE
          echo "python3 scripts/generate_html_coverage.py ios/Packages/Troop900Application" >> $SUMMARY_FILE
          echo '```' >> $SUMMARY_FILE
          
          # Also output to GitHub step summary
          cat $SUMMARY_FILE >> $GITHUB_STEP_SUMMARY
      
      - name: Upload All Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: complete-coverage-reports
          path: |
            coverage-reports/
            ios/Packages/*/COVERAGE_REPORT.md
            ios/Packages/*/coverage_report.html
            ios/Packages/*/COVERAGE_ANALYSIS_SUMMARY.md
          retention-days: 90
      
      - name: Create Coverage Badge Data
        run: |
          # Calculate average coverage across all packages
          PACKAGES=(
            "Troop900Application"
            "Troop900Domain"
            "Troop900Data"
            "Troop900Presentation"
            "Troop900DesignSystem"
            "Troop900Bootstrap"
          )
          
          TOTAL=0
          COUNT=0
          
          for package in "${PACKAGES[@]}"; do
            REPORT="ios/Packages/$package/COVERAGE_REPORT.md"
            if [ -f "$REPORT" ]; then
              OVERALL=$(grep "Combined Coverage Score:" "$REPORT" | head -1 | grep -oE '[0-9]+\.[0-9]+' | head -1 || echo "0")
              if [ ! -z "$OVERALL" ]; then
                TOTAL=$(echo "$TOTAL + $OVERALL" | bc)
                COUNT=$((COUNT + 1))
              fi
            fi
          done
          
          if [ $COUNT -gt 0 ]; then
            AVERAGE=$(echo "scale=1; $TOTAL / $COUNT" | bc)
            echo "Average Coverage: ${AVERAGE}%"
            echo "${AVERAGE}" > coverage-reports/average_coverage.txt
          fi
