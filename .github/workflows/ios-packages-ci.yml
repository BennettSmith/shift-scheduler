name: iOS Packages CI

on:
  push:
    branches: [ main ]
    paths:
      - 'ios/Packages/**'
      - 'ios/ShiftScheduler/**'
      - '.github/workflows/ios-packages-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'ios/Packages/**'
      - 'ios/ShiftScheduler/**'

jobs:
  detect-changes:
    name: Detect iOS package changes
    runs-on: ubuntu-latest
    outputs:
      troop900_domain: ${{ steps.filter.outputs.troop900_domain }}
      troop900_data: ${{ steps.filter.outputs.troop900_data }}
      troop900_presentation: ${{ steps.filter.outputs.troop900_presentation }}
      shift_scheduler: ${{ steps.filter.outputs.shift_scheduler }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            troop900_domain:
              - 'ios/Packages/Troop900Domain/**'
            troop900_data:
              - 'ios/Packages/Troop900Data/**'
            troop900_presentation:
              - 'ios/Packages/Troop900Presentation/**'
            shift_scheduler:
              - 'ios/ShiftScheduler/**'

  test-domain:
    name: Troop900Domain - swift test
    runs-on: macos-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.troop900_domain == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (latest available)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Troop900Domain tests
        run: |
          cd ios/Packages/Troop900Domain
          swift test

  test-data:
    name: Troop900Data - swift test
    runs-on: macos-latest
    needs: [detect-changes, test-domain]
    if: needs.detect-changes.outputs.troop900_data == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (latest available)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Troop900Data tests
        run: |
          cd ios/Packages/Troop900Data
          swift test

  test-presentation:
    name: Troop900Presentation - swift test
    runs-on: macos-latest
    needs: [detect-changes, test-data]
    if: needs.detect-changes.outputs.troop900_presentation == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (latest available)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Troop900Presentation tests
        run: |
          cd ios/Packages/Troop900Presentation
          swift test

  test-app:
    name: ShiftScheduler app - xcodebuild test
    runs-on: macos-latest
    needs: [detect-changes, test-presentation]
    if: needs.detect-changes.outputs.shift_scheduler == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (latest available)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build and test ShiftScheduler
        run: |
          cd ios
          xcodebuild \
            -scheme ShiftScheduler \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,OS=26.1,name=iPhone 16 Pro Max' \
            -skip-testing:ShiftSchedulerUITests \
            test

